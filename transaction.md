# トランザクション
トランザクション : データベースに対する1つ以上の更新をまとめて呼ぶときの総称

例としてshohinテーブルにおいて，カッターシャツの値段を1000円下げて，Tシャツの値段を1000あげる処理を考える。この処理は2つの更新によって構成され，同時に行う必要がある。このような複数の処理を同時に行うときに用いるのがトランザクションである。

## トランザクションの文法
トランザクションの開始はpostgreSQLの場合にはトランザクション開始文`BEGIN TRANSACTION`で宣言する。その後にDML文を記述する。トランザクション終了時には`COMMIT`または`ROLLBACK`のどちらかを記述する。

- `COMMIT` : トランザクション開始文からCOMMITまでのDML文の内容をデータベースに反映する。注意点としてCOMMITが実行されるまでは，DML文の内容が実際のデータベースに反映されておらず，COMMITした段階でまとめて処理が反映される。
- `ROLLBACK` : トランザクション開始文からROLLBACKまでのDML文の内容をデータベースに反映せずに，処理を取り消す。

```sql
BEGIN TRANSACTION;

DML文1;
DML文2;
...

COMMIT;
```

Q. トランザクション中にエラーが発生したらどうなるのか?  
例として次のようなトランザクション実行を考える。このトランザクションのDML文1がエラーにより失敗したとする。このとき，まずDML文2はそもそも実行されず，トランザクション自体が失敗となる。またこの状態でCOMMITを行っても失敗となる。  
ただし，トランザクション自体は継続しているため，ROLLBACKでトランザクションを終了させる必要がある。ROLLBACKを実行すると，更新内容が取り消され，トランザクションは終了する。これがROLLBACKの使い方である。

```sql
BEGIN TRANSACTION;

-- DML文1 (ここでエラーが発生)
INSERT INTO table_name (id, column1) VALUES (1, 'value1'); -- 例えば、重複キーエラー

-- DML文2 (実行されない)
UPDATE table_name SET column1 = 'new_value' WHERE id = 1;

COMMIT;
```

Q. これまで記述していた文にBEGIN TRANSACTIONやCOMMITが必要なかったのはなぜか?  
自動コミットモードが設定されているため。自動コミットモードでは，1つのSQL文を1つのトランザクションとみなしてトランザクション処理を行う。ユーザが明示的にBEGIN TRANSACTION～COMMIT/ROLLBACKしたときは，これを1つのトランザクションとみなして処理が行われる。

## ACID特性
トランザクション処理が備えているべき4つの特性をACID特性という. 4つの特性を次に示す.
- 原始性(Atomicity) : トランザクションが正常終了した場合にのみデータベースへの反映を保証(commit)し, 異常終了した場合には何もなかった状態に戻す(rollback)こと

- 一貫性(Consistency) : トランザクションの処理によってデータベース内に矛盾が生じない, 整合性が保たれた状態であること

- 独立性(Isolation) : 複数のトランザクションを同時に実行したときと, 直列に実行したときで処理結果が一致すること

- 耐久性(Durability) : いったん正常終了したトランザクションの結果は, その後障害が発生してもデータベースから消失しないこと